<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng Th∆∞ Vi·ªán V2</title>
    <style>
        body { font-family: sans-serif; max-width: 900px; margin: auto; padding: 20px; display: flex; gap: 40px; }
        h1, h2, h3 { color: #333; }
        .section { flex: 1; }
        .item { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; border-radius: 5px; }
        .item button { margin-top: 5px; cursor: pointer; }
    </style>
</head>
<body>

    <div class="section">
        <h1>üìö S√°ch Trong Th∆∞ Vi·ªán</h1>
        <div id="book-list"></div>
    </div>

    <div class="section">
        <h1>üìã Phi·∫øu M∆∞·ª£n Hi·ªán T·∫°i</h1>
        <div id="borrow-list"></div>
    </div>

    <script>
        const API_URL = '/api';

        // --- C√ÅC H√ÄM G·ªåI API V√Ä V·∫º L·∫†I GIAO DI·ªÜN ---

        // H√†m l·∫•y danh s√°ch s√°ch v√† hi·ªÉn th·ªã
        async function fetchBooks() {
            const response = await fetch(`${API_URL}/books`);
            const books = await response.json();
            const bookListDiv = document.getElementById('book-list');
            bookListDiv.innerHTML = ''; // X√≥a danh s√°ch c≈©

            books.forEach(book => {
                const bookDiv = document.createElement('div');
                bookDiv.className = 'item';
                bookDiv.innerHTML = `
                    <strong>${book.title}</strong> - <em>${book.author}</em><br>
                    <span>S·ªë l∆∞·ª£ng c√≤n l·∫°i: ${book.quantity}</span><br>
                    <button onclick="borrowBook(${book.id})" ${book.quantity <= 0 ? 'disabled' : ''}>M∆∞·ª£n S√°ch</button>
                `;
                bookListDiv.appendChild(bookDiv);
            });
        }

        // H√†m l·∫•y danh s√°ch phi·∫øu m∆∞·ª£n v√† hi·ªÉn th·ªã
        async function fetchBorrowRecords() {
            // L∆∞u √Ω: Server V2 c·∫ßn c√≥ API ƒë·ªÉ l·∫•y danh s√°ch phi·∫øu m∆∞·ª£n
            // Ch√∫ng ta s·∫Ω th√™m n√≥ v√†o app_v2.py
            const response = await fetch(`${API_URL}/borrow-records`);
            const records = await response.json();
            const borrowListDiv = document.getElementById('borrow-list');
            borrowListDiv.innerHTML = ''; // X√≥a danh s√°ch c≈©

            records.forEach(record => {
                // Ch·ªâ hi·ªÉn th·ªã c√°c phi·∫øu ch∆∞a tr·∫£
                if (!record.is_returned) {
                    const recordDiv = document.createElement('div');
                    recordDiv.className = 'item';
                    recordDiv.innerHTML = `
                        <strong>S√°ch: ${record.book_title}</strong> (ID phi·∫øu: ${record.id})<br>
                        <span>Ng√†y m∆∞·ª£n: ${new Date(record.borrow_date).toLocaleString()}</span><br>
                        <button onclick="returnBook(${record.id})">Tr·∫£ S√°ch</button>
                    `;
                    borrowListDiv.appendChild(recordDiv);
                }
            });
        }

        // H√†m l√†m m·ªõi to√†n b·ªô d·ªØ li·ªáu tr√™n trang
        function refreshAllData() {
            fetchBooks();
            fetchBorrowRecords();
        }


        // --- C√ÅC H√ÄM X·ª¨ L√ù H√ÄNH ƒê·ªòNG C·ª¶A NG∆Ø·ªúI D√ôNG ---

        // H√†m g·ªçi API t·∫°o phi·∫øu m∆∞·ª£n m·ªõi
        async function borrowBook(bookId) {
            const response = await fetch(`${API_URL}/borrow-records`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ book_id: bookId, user_id: 1 }) // G·ª≠i k√®m book_id
            });
            const result = await response.json();
            if (response.ok) {
                alert(result.message);
            } else {
                alert(`L·ªói: ${result.error}`);
            }
            refreshAllData(); // T·∫£i l·∫°i c·∫£ 2 danh s√°ch
        }

        // H√†m g·ªçi API ƒë·ªÉ x√≥a (tr·∫£) m·ªôt phi·∫øu m∆∞·ª£n
        async function returnBook(recordId) {
            const response = await fetch(`${API_URL}/borrow-records/${recordId}`, {
                method: 'DELETE'
            });
            const result = await response.json();
            alert(result.message);
            refreshAllData(); // T·∫£i l·∫°i c·∫£ 2 danh s√°ch
        }

        // T·∫£i to√†n b·ªô d·ªØ li·ªáu khi trang ƒë∆∞·ª£c m·ªü l·∫ßn ƒë·∫ßu
        window.onload = refreshAllData;
    </script>

</body>
</html>